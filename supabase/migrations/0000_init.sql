-- Drop function if it exists to prevent conflict
DROP FUNCTION IF EXISTS public.activate_account(text, uuid);
DROP FUNCTION IF EXISTS public.handle_new_user();

-- 1. Create profiles table
create table if not exists public.profiles (
    id uuid not null,
    plan text not null default 'TRIAL'::text,
    role text not null default 'USER'::text,
    school_name text null,
    school_code text null,
    email text null,
    constraint profiles_pkey primary key (id),
    constraint profiles_id_fkey foreign key (id) references auth.users (id) on delete cascade,
    constraint school_code_unique unique (school_code)
);
alter table public.profiles enable row level security;

-- 2. Create students table
create table if not exists public.students (
    id uuid not null,
    nis text not null,
    name text not null,
    class text not null,
    whatsapp_number text null,
    created_at timestamp with time zone not null default now(),
    user_id uuid not null,
    constraint students_pkey primary key (id),
    constraint students_id_fkey foreign key (id) references auth.users (id) on delete cascade,
    constraint students_user_id_fkey foreign key (user_id) references auth.users (id) on delete cascade,
    constraint students_nis_user_id_key unique (nis, user_id)
);
alter table public.students enable row level security;

-- 3. Create transactions table
create table if not exists public.transactions (
    id uuid not null default gen_random_uuid(),
    created_at timestamp with time zone not null default now(),
    type text not null,
    description text not null,
    amount real not null,
    student_id uuid not null,
    user_id uuid not null,
    constraint transactions_pkey primary key (id),
    constraint transactions_student_id_fkey foreign key (student_id) references public.students (id) on delete cascade,
    constraint transactions_user_id_fkey foreign key (user_id) references auth.users (id) on delete cascade
);
alter table public.transactions enable row level security;

-- 4. Create activation_codes table
create table if not exists public.activation_codes (
    id bigint generated by default as identity,
    created_at timestamp with time zone not null default now(),
    code text not null,
    is_used boolean not null default false,
    used_by uuid null,
    used_at timestamp with time zone null,
    constraint activation_codes_pkey primary key (id),
    constraint activation_codes_code_key unique (code),
    constraint activation_codes_used_by_fkey foreign key (used_by) references auth.users (id) on delete set null
);
alter table public.activation_codes enable row level security;

-- RLS Policies

-- Profiles
create policy "Users can manage their own profile." on public.profiles for all
    using (auth.uid() = id);

-- Students
create policy "Users can manage their own students." on public.students for all
    using (auth.uid() = user_id);

-- Transactions
create policy "Users can manage their own transactions." on public.transactions for all
    using (auth.uid() = user_id);

-- Activation Codes
create policy "Admins can manage activation codes." on public.activation_codes for all
    using ((select role from public.profiles where id = auth.uid()) = 'ADMIN');


-- Functions & Triggers (MOVED TO THE END)

-- Function to handle new user and insert into profiles
create or replace function public.handle_new_user()
returns trigger
language plpgsql
security definer set search_path = public
as $$
begin
  insert into public.profiles (id, email)
  values (new.id, new.email);
  return new;
end;
$$;

-- Trigger to call handle_new_user on new user creation
create trigger on_auth_user_created
  after insert on auth.users
  for each row execute procedure public.handle_new_user();

-- Function for account activation
create or replace function public.activate_account(p_code text, p_user_id uuid)
returns void
language plpgsql
as $$
declare
  v_code_id bigint;
begin
  -- Find the code and lock the row
  select id into v_code_id from public.activation_codes where code = p_code and is_used = false for update;

  -- If code is not found or already used, raise an exception
  if v_code_id is null then
    raise exception 'invalid_or_used_code';
  end if;

  -- Mark the code as used
  update public.activation_codes
  set is_used = true,
      used_by = p_user_id,
      used_at = now()
  where id = v_code_id;

  -- Update the user's profile to PRO
  update public.profiles
  set plan = 'PRO'
  where id = p_user_id;
end;
$$;
